<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rally Sergio</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
</head>

<body>

    <div class="container">
        <table class="table">

            <thead>
                <tr>
                    <th>#</th>
                    <th>Nombre</th>
                    <th>Numero</th>
                    <th>Categoria</th>
                    <th>Salida 1</th>
                    <th>llegada 1</th>
                    <th>Total 1</th>
                    <th>Salida 2</th>
                    <th>Llegada 2</th>
                    <th>Total 2</th>
                </tr>
            </thead>

            <tbody id="tbody1">

            </tbody>
        </table>
    </div>

    <script type="module">
        //--------------------------filling table-------------------------------
        var stdNo = 0;
        var tbody = document.getElementById('tbody1');


        function AddItemToTable(nombre, numero, categoria, salida1, llegada1, salida2, llegada2) {
            let trow = document.createElement("tr");
            let td1 = document.createElement('td');
            let td2 = document.createElement('td');
            let td3 = document.createElement('td');
            let td4 = document.createElement('td');
            let td5 = document.createElement('td');
            let td6 = document.createElement('td');
            let td7 = document.createElement('td');
            let td8 = document.createElement('td');
            let td9 = document.createElement('td');
            let td10 = document.createElement('td');
            let td11 = document.createElement('td');


            td1.innerHTML = ++stdNo;
            td2.innerHTML = nombre;
            td3.innerHTML = numero;
            td4.innerHTML = categoria;
            td5.innerHTML = salida1;
            td6.innerHTML = llegada1;
            td7.innerHTML = getTotal(salida1, llegada1);

            td8.innerHTML = salida2;
            td9.innerHTML = llegada2;
            td10.innerHTML = getTotal(salida2, llegada2);


            trow.appendChild(td1);
            trow.appendChild(td2);
            trow.appendChild(td3);
            trow.appendChild(td4);
            trow.appendChild(td5);
            trow.appendChild(td6);
            trow.appendChild(td7);
            trow.appendChild(td8);
            trow.appendChild(td9);
            trow.appendChild(td10);

            tbody.appendChild(trow);

        }

        function AddAllItemsToTable(TheStudent) {
            stdNo = 0;
            tbody.innerHTML = "";
            TheStudent.forEach(element => {
                AddItemToTable(element.nombre, element.numero, element.categoria, element.salida1, element.llegada1, element.salida2, element.llegada2);
            });
        }

        function getTotal(uno, dos) {
            const array1 = uno.split(":");
            let hora1 = array1[0];
            let minuto1 = array1[1];
            let segundo1 = array1[2];
            let milisec1 = array1[3];

            const array2 = dos.split(":");
            let hora2 = array2[0];
            let minuto2 = array2[1];
            let segundo2 = array2[2];
            let milisec2 = array2[3];

            let minT = parseInt(minuto2) - parseInt(minuto1);
            let secT = parseInt(segundo2) - parseInt(segundo1);
            let miliT = parseInt(milisec2) - parseInt(milisec1);

            let str = '' + minT + ":" + secT + ":" + miliT;

            if (dos == "") {
                return "No llego";
            }


            return str;
        }
        /*-------------------imports configuracion---------------*/


        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-app.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCHWj54PFXaWluJyOVx5GMzddyMmiTRcxc",
            authDomain: "emailpasswordauth-2bf1e.firebaseapp.com",
            projectId: "emailpasswordauth-2bf1e",
            storageBucket: "emailpasswordauth-2bf1e.appspot.com",
            messagingSenderId: "334370689492",
            appId: "1:334370689492:web:79db7a6cc45e5577f3c641"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        import {
            getFirestore, doc, getDoc, getDocs, onSnapshot, collection
        }
            from "https://www.gstatic.com/firebasejs/9.9.2/firebase-firestore.js";

        const db = getFirestore(app);

        //--get all data//
        async function GetAllDataOnce() {
            const querySnapshot = await getDocs(collection(db, "open").orderBy('categoria'));
            var students = [];
            querySnapshot.forEach(doc => {
                students.push(doc.data());
                console.log(doc.data());
            });

            students.sort((a, b) => a.categoria.localeCompare(b.categoria))

            AddAllItemsToTable(students);
        }



        async function GetAllDataRealtime() {
            const dbRef = collection(db, "open");
            onSnapshot(dbRef, (querySnapshot) => {
                var students = [];
                querySnapshot.forEach(doc => {
                    students.push(doc.data());
                    console.log(doc.data());
                })
                AddAllItemsToTable(students);
            });

        }

        window.onload = GetAllDataRealtime;



    </script>

</body>

</html>
